
/*                       C O P Y R I G H T   N O T I C E
 *
 * Copyright Â©2021. Institute of Science and Technology Austria (IST Austria).
 * All Rights Reserved. The underlying technology is protected by PCT Patent
 * Application No. PCT/EP2021/054650.
 *
 * This file is part of the AP Demodulation library, which is free software: you can
 * redistribute it and/or modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation in version 2.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY, without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
 * PARTICULAR PURPOSE. See the GNU General Public License v2 for more details. You
 * should have received a copy of the GNU General Public License v2 along with this
 * program. If not, see https://www.gnu.org/licenses/.
 *
 * Contact the Technology Transfer Office, IST Austria, Am Campus 1,
 * A-3400 Klosterneuburg, Austria, +43-(0)2243 9000, twist@ist.ac.at, for commercial
 * licensing opportunities.
 *
 * All other inquiries should be directed to the author, Mantas Gabrielaitis,
 * mgabriel@ist.ac.at
 */



/* EXAMPLE 3
 *
 * In this example, a nonuniformly sampled 1D amplitude-modulated signal built from a
 * white-noise carrier and an LP-random modulator is generated and demodulated by
 * using the AP-Projected algorithm. Sample points of the the predefined and inferred
 * modulators and carriers as well as their time coordinates are then written to a
 * text file for further analysis. This example illustrates application of the
 * function 'f_ap_demodulation' for demodulating nonuniformly sampled signals. */



#include <stdio.h>

#include <math.h>

#include "f_ap_demodulation.c"



#ifdef _WIN32
    
    #define STR_NL "\r"

#else

    #define STR_NL "\n"

#endif



int main(void)
{

    /* Declarations and initializations */
    
    int line;
    
    int exitflag = 0;
    
    
    long i, j, iter, n;
    
    double *m=NULL, *c=NULL, *s=NULL, *Ub=NULL;
    
    double *out_m=NULL, *out_c=NULL, *out_e=NULL;
    
    double t[] = {0.0000, 0.0087, 0.0213, 0.0246, 0.0318, 0.0370, 0.0414, 0.0471, \
                  0.0549, 0.0633, 0.0736, 0.0823, 0.0945, 0.1004, 0.1151, 0.1187, \
                  0.1307, 0.1394, 0.1500, 0.1551, 0.1609, 0.1746, 0.1905, 0.1978, \
                  0.2101, 0.2248, 0.2397, 0.2441, 0.2478, 0.2533, 0.2680, 0.2725, \
                  0.2813, 0.2970, 0.3072, 0.3195, 0.3269, 0.3391, 0.3532, 0.3567, \
                  0.3698, 0.3859, 0.3989, 0.4058, 0.4194, 0.4240, 0.4331, 0.4482, \
                  0.4553, 0.4623, 0.4672, 0.4707, 0.4828, 0.4888, 0.4956, 0.5052, \
                  0.5092, 0.5199, 0.5251, 0.5360, 0.5484, 0.5530, 0.5617, 0.5740, \
                  0.5826, 0.5865, 0.5968, 0.6087, 0.6187, 0.6342, 0.6451, 0.6602, \
                  0.6652, 0.6703, 0.6841, 0.6925, 0.6979, 0.7133, 0.7211, 0.7341, \
                  0.7468, 0.7616, 0.7730, 0.7860, 0.7938, 0.8006, 0.8155, 0.8244, \
                  0.8402, 0.8521, 0.8635, 0.8682, 0.8839, 0.8930, 0.9038, 0.9124, \
                  0.9187, 0.9337, 0.9445, 0.9478, 0.9591, 0.9666, 0.9767, 0.9915, \
                  0.9994, 1.0145, 1.0259, 1.0294, 1.0447, 1.0570, 1.0733, 1.0788, \
                  1.0838, 1.0992, 1.1116, 1.1157, 1.1288, 1.1419, 1.1572, 1.1697, \
                  1.1746, 1.1781, 1.1817, 1.1853, 1.1918, 1.2063, 1.2165, 1.2270, \
                  1.2412, 1.2461, 1.2530, 1.2639, 1.2798, 1.2904, 1.2939, 1.3076, \
                  1.3138, 1.3276, 1.3359, 1.3505, 1.3634, 1.3740, 1.3790, 1.3830, \
                  1.3879, 1.3917, 1.3964, 1.4026, 1.4151, 1.4257, 1.4291, 1.4333, \
                  1.4492, 1.4598, 1.4657, 1.4723, 1.4852, 1.4910, 1.5019, 1.5178, \
                  1.5321, 1.5384, 1.5481, 1.5595, 1.5735, 1.5788, 1.5823, 1.5865, \
                  1.5961, 1.6073, 1.6179, 1.6253, 1.6415, 1.6523, 1.6605, 1.6709, \
                  1.6839, 1.6959, 1.7026, 1.7067, 1.7148, 1.7263, 1.7323, 1.7453, \
                  1.7495, 1.7561, 1.7699, 1.7756, 1.7872, 1.7973, 1.8126, 1.8193, \
                  1.8235, 1.8363, 1.8496, 1.8647, 1.8801, 1.8835, 1.8899, 1.9012, \
                  1.9168, 1.9324, 1.9429, 1.9581, 1.9697, 1.9781, 1.9877, 1.9988, \
                  2.0092, 2.0246, 2.0398, 2.0482, 2.0640, 2.0695, 2.0744, 2.0795, \
                  2.0893, 2.0929, 2.1085, 2.1225, 2.1260, 2.1315, 2.1391, 2.1441, \
                  2.1579, 2.1656, 2.1811, 2.1920, 2.2067, 2.2210, 2.2360, 2.2453, \
                  2.2556, 2.2693, 2.2763, 2.2859, 2.2970, 2.3005, 2.3115, 2.3204, \
                  2.3342, 2.3415, 2.3564, 2.3672, 2.3729, 2.3864, 2.3976, 2.4016, \
                  2.4103, 2.4224, 2.4377, 2.4409, 2.4569, 2.4651, 2.4810, 2.4922, \
                  2.5062, 2.5170, 2.5284, 2.5354, 2.5463, 2.5593, 2.5738, 2.5869, \
                  2.5992, 2.6138, 2.6212, 2.6332, 2.6424, 2.6506, 2.6592, 2.6677, \
                  2.6751, 2.6865, 2.6953, 2.7113, 2.7234, 2.7292, 2.7380, 2.7458, \
                  2.7594, 2.7741, 2.7892, 2.8011, 2.8079, 2.8144, 2.8288, 2.8389, \
                  2.8527, 2.8634, 2.8762, 2.8862, 2.8995, 2.9102, 2.9195, 2.9272, \
                  2.9314, 2.9396, 2.9439, 2.9599, 2.9656, 2.9794, 2.9941, 3.0063, \
                  3.0170, 3.0223, 3.0317, 3.0394, 3.0456, 3.0566, 3.0639, 3.0791, \
                  3.0942, 3.1009, 3.1056, 3.1113, 3.1211, 3.1339, 3.1398, 3.1463, \
                  3.1607, 3.1693, 3.1806, 3.1869, 3.1915, 3.2015, 3.2110, 3.2162, \
                  3.2276, 3.2380, 3.2497, 3.2549, 3.2679, 3.2741, 3.2841, 3.2976, \
                  3.3012, 3.3086, 3.3233, 3.3375, 3.3478, 3.3624, 3.3780, 3.3920, \
                  3.4064, 3.4110, 3.4227, 3.4351, 3.4464, 3.4600, 3.4637, 3.4770, \
                  3.4898, 3.4965, 3.5031, 3.5146, 3.5223, 3.5360, 3.5451, 3.5585, \
                  3.5747, 3.5819, 3.5870, 3.6020, 3.6123, 3.6283, 3.6398, 3.6560, \
                  3.6664, 3.6765, 3.6815, 3.6894, 3.6930, 3.6984, 3.7114, 3.7150, \
                  3.7231, 3.7376, 3.7498, 3.7621, 3.7678, 3.7768, 3.7877, 3.8038, \
                  3.8097, 3.8162, 3.8229, 3.8359, 3.8452, 3.8492, 3.8590, 3.8651, \
                  3.8787, 3.8859, 3.8895, 3.9005, 3.9147, 3.9230, 3.9360, 3.9459, \
                  3.9562, 3.9720, 3.9857, 3.9894, 4.0019, 4.0112, 4.0268, 4.0330, \
                  4.0397, 4.0440, 4.0529, 4.0575, 4.0691, 4.0828, 4.0951, 4.1084, \
                  4.1161, 4.1304, 4.1392, 4.1532, 4.1646, 4.1698, 4.1741, 4.1775, \
                  4.1817, 4.1909, 4.1956, 4.1993, 4.2124, 4.2208, 4.2338, 4.2429, \
                  4.2520, 4.2615, 4.2710, 4.2847, 4.2932, 4.3082, 4.3120, 4.3253, \
                  4.3302, 4.3415, 4.3449, 4.3552, 4.3585, 4.3742, 4.3892, 4.4029, \
                  4.4180, 4.4232, 4.4285, 4.4342, 4.4456, 4.4607, 4.4768, 4.4893, \
                  4.5021, 4.5172, 4.5257, 4.5322, 4.5378, 4.5426, 4.5564, 4.5616, \
                  4.5683, 4.5822, 4.5895, 4.6056, 4.6123, 4.6225, 4.6299, 4.6450, \
                  4.6531, 4.6620, 4.6719, 4.6874, 4.6911, 4.7037, 4.7185, 4.7222, \
                  4.7322, 4.7397, 4.7542, 4.7647, 4.7770, 4.7861, 4.7976, 4.8046, \
                  4.8080, 4.8188, 4.8261, 4.8361, 4.8513, 4.8601, 4.8666, 4.8747, \
                  4.8901, 4.9056, 4.9198, 4.9351, 4.9413, 4.9457, 4.9519, 4.9593, \
                  4.9648, 4.9760, 4.9846, 4.9985, 5.0042, 5.0166, 5.0230, 5.0337, \
                  5.0415, 5.0455, 5.0518, 5.0637, 5.0734, 5.0835, 5.0890, 5.0997, \
                  5.1159, 5.1298, 5.1409, 5.1568, 5.1718, 5.1829, 5.1865, 5.1910, \
                  5.1951, 5.2043, 5.2124, 5.2284, 5.2338, 5.2498, 5.2630, 5.2770, \
                  5.2885, 5.3005, 5.3100, 5.3134, 5.3213, 5.3310, 5.3437, 5.3531, \
                  5.3623, 5.3674, 5.3708, 5.3839, 5.3913, 5.4074, 5.4135, 5.4212, \
                  5.4313, 5.4444, 5.4537, 5.4586, 5.4659, 5.4758, 5.4878, 5.5011, \
                  5.5061, 5.5096, 5.5196, 5.5334, 5.5369, 5.5489, 5.5611, 5.5702, \
                  5.5854, 5.5970, 5.6004, 5.6099, 5.6244, 5.6385, 5.6502, 5.6622, \
                  5.6730, 5.6799, 5.6904, 5.7024, 5.7103, 5.7247, 5.7305, 5.7435, \
                  5.7505, 5.7639, 5.7727, 5.7865, 5.7944, 5.8004, 5.8137, 5.8210, \
                  5.8338, 5.8467, 5.8529, 5.8589, 5.8648, 5.8699, 5.8781, 5.8817, \
                  5.8864, 5.8984, 5.9121, 5.9164, 5.9227, 5.9287, 5.9439, 5.9564, \
                  5.9669, 5.9741, 5.9882, 5.9972, 6.0125, 6.0249, 6.0344, 6.0393, \
                  6.0553, 6.0606, 6.0665, 6.0754, 6.0839, 6.0891, 6.1019, 6.1076, \
                  6.1192, 6.1323, 6.1383, 6.1494, 6.1624, 6.1740, 6.1851, 6.1922, \
                  6.2050, 6.2205, 6.2293, 6.2428, 6.2468, 6.2609, 6.2667, 6.2751, \
                  6.2823, 6.2866, 6.3016, 6.3097, 6.3199, 6.3296, 6.3346, 6.3405, \
                  6.3448, 6.3546, 6.3613, 6.3692, 6.3739, 6.3874, 6.3921, 6.4082, \
                  6.4137, 6.4244, 6.4283, 6.4418, 6.4475, 6.4577, 6.4706, 6.4758, \
                  6.4862, 6.4923, 6.5055, 6.5181, 6.5237, 6.5382, 6.5417, 6.5562, \
                  6.5667, 6.5752, 6.5884, 6.6010, 6.6171, 6.6240, 6.6273, 6.6427, \
                  6.6572, 6.6699, 6.6799, 6.6924, 6.7058, 6.7140, 6.7273, 6.7403, \
                  6.7516, 6.7600, 6.7724, 6.7757, 6.7891, 6.8040, 6.8104, 6.8152, \
                  6.8213, 6.8285, 6.8433, 6.8536, 6.8606, 6.8657, 6.8727, 6.8840, \
                  6.8915, 6.9007, 6.9097, 6.9238, 6.9326, 6.9404, 6.9524, 6.9586, \
                  6.9679, 6.9753, 6.9867, 7.0014, 7.0105, 7.0240, 7.0332, 7.0450, \
                  7.0500, 7.0589, 7.0740, 7.0851, 7.0984, 7.1082, 7.1180, 7.1322, \
                  7.1364, 7.1471, 7.1626, 7.1726, 7.1784, 7.1927, 7.1993, 7.2117, \
                  7.2220, 7.2376, 7.2490, 7.2632, 7.2665, 7.2827, 7.2869, 7.2944, \
                  7.3100, 7.3134, 7.3274, 7.3418, 7.3508, 7.3574, 7.3711, 7.3806, \
                  7.3856, 7.4010, 7.4159, 7.4256, 7.4400, 7.4487, 7.4609, 7.4693, \
                  7.4792, 7.4849, 7.5007, 7.5078, 7.5124, 7.5176, 7.5210, 7.5336, \
                  7.5442, 7.5578, 7.5677, 7.5813, 7.5936, 7.6070, 7.6156, 7.6273, \
                  7.6329, 7.6403, 7.6458, 7.6544, 7.6608, 7.6694, 7.6853, 7.6928, \
                  7.7088, 7.7204, 7.7285, 7.7430, 7.7543, 7.7608, 7.7744, 7.7833, \
                  7.7913, 7.7988, 7.8112, 7.8179, 7.8317, 7.8388, 7.8492, 7.8588, \
                  7.8732, 7.8880, 7.8937, 7.9046, 7.9196, 7.9286, 7.9439, 7.9508, \
                  7.9620, 7.9741, 7.9804, 7.9838, 7.9925, 8.0080, 8.0157, 8.0291, \
                  8.0347, 8.0424, 8.0475, 8.0601, 8.0725, 8.0847, 8.0913, 8.1036, \
                  8.1098, 8.1186, 8.1267, 8.1346, 8.1386, 8.1501, 8.1626, 8.1738, \
                  8.1855, 8.1910, 8.1962, 8.2062, 8.2208, 8.2265, 8.2358, 8.2446, \
                  8.2544, 8.2597, 8.2674, 8.2741, 8.2884, 8.3021, 8.3109, 8.3221, \
                  8.3272, 8.3371, 8.3442, 8.3587, 8.3707, 8.3822, 8.3871, 8.3965, \
                  8.4126, 8.4282, 8.4399, 8.4451, 8.4567, 8.4674, 8.4767, 8.4856, \
                  8.4966, 8.5110, 8.5240, 8.5348, 8.5501, 8.5542, 8.5704, 8.5744, \
                  8.5802, 8.5890, 8.5936, 8.6050, 8.6089, 8.6159, 8.6199, 8.6324, \
                  8.6443, 8.6525, 8.6582, 8.6712, 8.6789, 8.6925, 8.7022, 8.7123, \
                  8.7159, 8.7276, 8.7354, 8.7416, 8.7505, 8.7588, 8.7682, 8.7842, \
                  8.7922, 8.8056, 8.8160, 8.8309, 8.8387, 8.8452, 8.8603, 8.8642, \
                  8.8798, 8.8903, 8.8985, 8.9147, 8.9187, 8.9287, 8.9324, 8.9431, \
                  8.9487, 8.9602, 8.9762, 8.9909, 9.0000, 9.0125, 9.0259, 9.0356, \
                  9.0458, 9.0510, 9.0591, 9.0642, 9.0769, 9.0864, 9.0955, 9.1103, \
                  9.1204, 9.1290, 9.1358, 9.1400, 9.1487, 9.1523, 9.1593, 9.1692, \
                  9.1850, 9.1897, 9.2017, 9.2115, 9.2249, 9.2300, 9.2343, 9.2428, \
                  9.2565, 9.2622, 9.2755, 9.2825, 9.2886, 9.2921, 9.3005, 9.3088, \
                  9.3206, 9.3248, 9.3300, 9.3335, 9.3383, 9.3500, 9.3585, 9.3660, \
                  9.3765, 9.3927, 9.4068, 9.4192, 9.4344, 9.4382, 9.4424, 9.4518, \
                  9.4596, 9.4751, 9.4847, 9.4950, 9.5100, 9.5190, 9.5337, 9.5403, \
                  9.5471, 9.5546, 9.5650, 9.5712, 9.5832, 9.5883, 9.5928, 9.6074, \
                  9.6137, 9.6220, 9.6327, 9.6428, 9.6471, 9.6617, 9.6774, 9.6912, \
                  9.6982, 9.7083, 9.7160, 9.7265, 9.7425, 9.7498, 9.7618, 9.7693, \
                  9.7826, 9.7901, 9.8050, 9.8180, 9.8312, 9.8406, 9.8466, 9.8504, \
                  9.8579, 9.8616, 9.8739, 9.8859, 9.8948, 9.9080, 9.9183, 9.9221, \
                  9.9271, 9.9328, 9.9405, 9.9444, 9.9556, 9.9655, 9.9768, 9.9857};
     
    double w[] = {1.5648, 0.5312, 0.1413, 0.7588, -0.8616, -0.3586, 0.9106, -0.1787,\
                  -0.0108, -0.0989, -0.3559, -0.4015, 0.2917, -0.3458, -1.1990, \
                  0.7651, -0.9884, -1.1668, 0.6584, -1.3693, -0.4143, 0.6981, \
                  0.9181, 2.9477, -0.3757, 0.8218, -0.5699, -0.5495, -0.0108, \
                  0.0854, 1.0189, 1.7904, 0.7577, -0.8434, -0.7300, -0.8675, \
                  -0.6159, -0.3319, 1.4449, 0.6741};
                  
    struct s_ParamsAP Par;
    
    Par.Fs = NULL; Par.Fc = NULL; Par.Ns = NULL; Par.im = NULL; Par.ie = NULL;
    
    FILE *fid = NULL;


    
    /* Number of sample points */

    n = 1024;


    
    /* Modulator (LP-random) */

    m = (double*) calloc(n, sizeof(double));
    
    if (m == NULL) {line=__LINE__-2; exitflag=-1; goto failed;}
    

    for (i=0; i<n; i++)
    {
        for (j=0; j<20; j++)

            m[i] = m[i] + w[2*j] * cos(2*M_PI*j*t[i]/10+w[1+2*j]); 

        m[i] = m[i] + 6.332617021244183;
        
        m[i] = m[i] / 13.595761447166774;
    }
    
    

    /* Carrier (sinusoidal) */

    c = (double*) calloc(n, sizeof(double));
    
    if (c == NULL) {line=__LINE__-2; exitflag=-1; goto failed;}
    

    for (i=0; i<n; i++)
    
        c[i] = sin(2*M_PI*5*t[i]);
    


    
    /* Signal */

    s = (double*) malloc(n*sizeof(double));
    
    if (s == NULL) {line=__LINE__-2; exitflag=-1; goto failed;}
    

    for (i=0; i<n; i++)

        s[i] = m[i] * c[i];



    /* Demodulation parameters */

    Par.Al = 'P';
    
    Par.D = 1;

    
    Par.Fs = (double*) malloc(1*sizeof(double));
    
    if (Par.Fs == NULL) {line=__LINE__-2; exitflag=-1; goto failed;}
    
    Par.Fs[0] = 1/0.009761186408537;
    

    Par.Fc = (double*) malloc(1*sizeof(double));
    
    if (Par.Fc == NULL) {line=__LINE__-2; exitflag=-1; goto failed;}
    
    Par.Fc[0] = 25 * Par.Fs[0] / (n*8);
    

    Par.Et = 1e-4;

    Par.Ni = 3e+4;
    
    
    Par.Ns = (long*) malloc(1*sizeof(long));
    
    if (Par.Ns == NULL) {line=__LINE__-2; exitflag=-1; goto failed;}

    Par.Ns[0] = n;
    
    
    Par.Nr = (long*) malloc(1*sizeof(long));
    
    if (Par.Nr == NULL) {line=__LINE__-2; exitflag=-1; goto failed;}
    
    Par.Nr[0] = n * 8;
    

    Par.Cp = 1;


    Par.im = (long*) malloc(2*sizeof(long));
    
    if (Par.im == NULL) {line=__LINE__-2; exitflag=-1; goto failed;}

    Par.im[0] = 1;
    
    Par.im[1] = Par.Ni; /* we ask for m estimate at the last iteration */


    Par.ie = (long*) malloc(2*sizeof(long));
    
    if (Par.ie == NULL) {line=__LINE__-2; exitflag=-1; goto failed;}

    Par.ie[0] = 1;
    
    Par.ie[1] = Par.Ni; /* we ask for e estimate at the last iteration */



    /* The array of modulator upper bound */

    Ub = NULL; /* we assume no upper bound on the modulator */



    /* Output arrays */

    out_m = (double*) malloc(Par.im[0]*n*sizeof(double));
    
    if (out_m == NULL) {line=__LINE__-2; exitflag=-1; goto failed;}
    
    
    out_c = (double*) malloc(Par.im[0]*n*sizeof(double));
    
    if (out_c == NULL) {line=__LINE__-2; exitflag=-1; goto failed;}
    
    
    out_e = (double*) malloc(Par.ie[0]*sizeof(double));
    
    if (out_e == NULL) {line=__LINE__-2; exitflag=-1; goto failed;}



    /* Demodulation */

    exitflag = f_ap_demodulation (s, &Par, Ub, t, out_m, out_e, &iter);
    
    if (exitflag != 0)
        
        goto finish;
    
    else
    {
        printf(STR_NL "Demodulation completed." STR_NL);
    
        printf(STR_NL "The infeasibility error is %e. " STR_NL, out_e[0]);

        printf(STR_NL "The number of used iterations is %ld" STR_NL, iter);
    }
    
    
    
    /* Carrier estimate */
    
    for (i=0; i<n; i++)

        out_c[i] = s[i] / out_m[i];
    
    
    
    /* Output. Values of the time coordinates, predefined and estimated modulators
     * and carriers are written to a text file as tab-delimited columns. */
    
    fid = fopen("./out_ex3.txt", "w");
    
    if (fid == NULL)
    {
        line = __LINE__-4;
        
        exitflag = -3;
        
        goto failed;
    }
    
    else
    {
        fprintf(fid, "t\t Mod.\t Carr.\t Mod. est.\t Carr. est." STR_NL);

        for (i=0; i<n; i++)

            fprintf(fid, "%e\t%e\t%e\t%e\t%e" STR_NL, t[i], m[i], c[i], out_m[i], \
                    out_c[i]);

        exitflag = fclose(fid);
        
        if (exitflag != 0)
        {
            line = __LINE__-4;
            
            exitflag = -4;
            
            goto failed;
        }
    }
    
    
    printf(STR_NL "Results saved." STR_NL);
    
    
    
    /* Output & Memory deallocation */
    
    goto finish;
    
    finish:
        
        free(m);
    
        free(c);

        free(s);

        free(Par.Fs);

        free(Par.Fc);

        free(Par.Ns);

        free(Par.Nr);

        free(Par.im);

        free(Par.ie);

        free(out_m);

        free(out_c);

        free(out_e);
        
        return exitflag;
                
    failed:
        
        if (exitflag == -1)
            
            fprintf (stderr, STR_NL "Error (line %d in %s): Out of memmory!" STR_NL,\
                    line, __FUNCTION__);
        
        else if (exitflag == -3)
            
            fprintf (stderr, STR_NL "Error (line %d in %s): out_ex3.txt could not "\
                             "be opened for writing!" STR_NL, line, __FUNCTION__);
        
        if (exitflag == -4)
            
            fprintf (stderr, STR_NL "Error (line %d in %s): stream to out_ex3.txt "\
                             "could not be closed!" STR_NL, line, __FUNCTION__);
        
        goto finish;
    
    
}

